---
import BlogLayout from "../../../layouts/BlogLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import TagBadge from "../../../components/TagBadge.astro";

export async function getStaticPaths() {
	const posts = await getCollection("blog", ({ data }) => {
		return true;
	});

	const allTags = Array.from(
		new Set(posts.flatMap((post) => post.data.tags || [])),
	)
		.filter((tag) => tag && tag.trim())
		.map((tag) => tag.trim())
		.sort();

	return allTags.map((tag) => ({
		params: { tag },
		props: {
			tag,
			posts: posts.filter((post) => post.data.tags?.includes(tag)),
		},
	}));
}

const { tag, posts } = Astro.props;

const postsByYear = posts.reduce(
	(acc, post) => {
		const year = post.data.pubDate.getFullYear();
		if (!acc[year]) {
			acc[year] = [];
		}
		acc[year].push(post);
		return acc;
	},
	{} as Record<number, CollectionEntry<"blog">[]>,
);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BlogLayout
	title={`Posts tagged with "${tag}" | Yasin Kavakli`}
	description={`${posts.length} posts tagged with "${tag}"`}
>
	<div class="max-w-2xl mx-auto">
		<header class="mb-12 md:mb-16 text-center space-y-4">
			<div
				class="inline-flex items-center gap-2 text-muted-foreground text-sm"
			>
				<a href="/blog" class="hover:text-foreground transition-colors"
					>Writing</a
				>
				<span>/</span>
				<span>Tag</span>
			</div>
			<h1 class="text-3xl md:text-5xl font-bold tracking-tight">{tag}</h1>
			<p class="text-muted-foreground">
				{posts.length} post{posts.length === 1 ? "" : "s"}
			</p>
		</header>

		<div class="space-y-16">
			{
				posts.length > 0 ? (
					years.map((year) => (
						<section>
							<h2 class="text-2xl font-bold mb-6 flex items-baseline gap-4">
								{year}
								<span class="h-px bg-border flex-1" />
							</h2>
							<ul class="space-y-6">
								{postsByYear[Number(year)].map((post) => (
									<li class="group">
										<a
											href={`/blog/${post.id}/`}
											class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-4"
										>
											<div class="flex-1">
												<h3 class="text-lg font-medium group-hover:text-primary transition-colors">
													{post.data.title}
												</h3>
											</div>
											<time
												datetime={post.data.pubDate.toISOString()}
												class="text-sm text-muted-foreground font-mono whitespace-nowrap"
											>
												{post.data.pubDate.toLocaleDateString(
													"en-us",
													{
														month: "short",
														day: "numeric",
													},
												)}
											</time>
										</a>
									</li>
								))}
							</ul>
						</section>
					))
				) : (
					<div class="text-center py-12 text-muted-foreground">
						No posts found.
						<br />
						<a
							href="/blog"
							class="text-primary hover:underline mt-4 inline-block"
						>
							View all posts
						</a>
					</div>
				)
			}
		</div>
	</div>
</BlogLayout>
