---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import TagBadge from "../../components/TagBadge.astro";
import { generateSlugFromTitle } from "../../lib/slug";

// Filter out drafts in production, show all in dev
const allPosts = (await getCollection("blog", ({ data }) => {
	return import.meta.env.PROD ? data.draft !== true : true;
})).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Redirect to home if no posts exist
if (allPosts.length === 0) {
	return Astro.redirect("/");
}

// Extract and deduplicate all tags
const allTags = Array.from(
	new Set(allPosts.flatMap((post) => post.data.tags || []))
).sort();

// Group posts by year
const postsByYear = allPosts.reduce(
	(acc, post) => {
		const year = post.data.pubDate.getFullYear();
		if (!acc[year]) {
			acc[year] = [];
		}
		acc[year].push(post);
		return acc;
	},
	{} as Record<number, typeof posts>,
);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));

const breadcrumbs = [{ label: "Writing" }];
---

<BaseLayout title="Writing | Yasin Kavakli" description="Thoughts on software, design, and everything in between." ogImage="/og/writing.png" breadcrumbs={breadcrumbs}>
	<main class="w-full">
		<div class="w-full max-w-xl px-4 mx-auto">
			<div class="flex flex-col gap-12 pb-8">
				<!-- Tags Section Title -->
				{allTags.length > 0 && (
					<div class="flex flex-col gap-2 -mb-12">
						<div class="text-sm font-semibold text-muted-foreground">Tags</div>
					</div>
				)}
			</div>
		</div>

		<!-- Tag Badges - Full Width -->
		{allTags.length > 0 && (
			<section class="w-full px-4 pt-6 flex justify-center">
				<div class="flex flex-wrap gap-2 justify-center">
					{allTags.map((tag) => (
						<TagBadge tag={tag} />
					))}
				</div>
			</section>
		)}

		<!-- Posts - Constrained Width -->
		<div class="w-full max-w-xl px-4 mx-auto">
			<div class="flex flex-col gap-12 py-8">
			<!-- Posts by Year -->
			{
				years.map((year) => (
					<section class="flex flex-col gap-4">
						<div class="text-muted-foreground text-sm select-none">
							{year}
						</div>
						<ul class="list-none p-0 m-0 flex flex-col gap-1">
							{postsByYear[Number(year)].map((post) => (
								<li>
									<a
										href={`/blog/${post.data.slug || generateSlugFromTitle(post.data.title)}/`}
										class="flex items-center gap-2 py-1.5 group"
									>
										<div class="flex-1">
											<div class="flex items-center gap-2">
												<span class="text-foreground font-medium leading-relaxed group-hover:underline underline-offset-2">{post.data.title}</span>
											</div>
											{post.data.draft && (
												<span class="inline-flex items-center rounded-md border border-transparent bg-secondary text-secondary-foreground px-2 py-0.5 text-xs font-medium mt-1">
													Draft
												</span>
											)}
										</div>
										<span class="text-muted-foreground text-xs font-mono tracking-tight">
											{post.data.pubDate.toLocaleDateString(
												"en-us",
												{
													month: "short",
													day: "numeric",
												},
											)}
										</span>
									</a>
								</li>
							))}
						</ul>
					</section>
				))
			}
			</div>
		</div>
	</main>
</BaseLayout>
