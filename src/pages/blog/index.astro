---
import BlogLayout from "../../layouts/BlogLayout.astro";
import { type CollectionEntry, getCollection } from "astro:content";
import { generateSlugFromTitle } from "../../lib/slug";

// Filter out drafts in production, show all in dev
const allPosts = (
	await getCollection("blog", ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	})
).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Redirect to home if no posts exist
if (allPosts.length === 0) {
	return Astro.redirect("/");
}

// Extract and deduplicate all tags
const allTags = Array.from(
	new Set(allPosts.flatMap((post) => post.data.tags || [])),
).sort();

// Group posts by year
const postsByYear = allPosts.reduce(
	(acc, post) => {
		const year = post.data.pubDate.getFullYear();
		if (!acc[year]) {
			acc[year] = [];
		}
		acc[year].push(post);
		return acc;
	},
	{} as Record<number, typeof allPosts>,
);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BlogLayout
	title="Writing | Yasin Kavakli"
	description="Thoughts on software, design, and everything in between."
	ogImage="/og/writing.png"
>
	<div class="max-w-2xl mx-auto">
		<header class="mb-12 md:mb-16 text-center space-y-4">
			<span
				class="text-sm font-semibold tracking-wider text-muted-foreground uppercase"
				>The Archive</span
			>
			<h1 class="text-3xl md:text-5xl font-bold tracking-tight">
				Writing
			</h1>
			<p class="text-muted-foreground">
				Thoughts on software, design, and everything in between.
			</p>
		</header>

		<!-- Posts by Year -->
		<div class="space-y-16">
			{
				years.map((year) => (
					<section>
						<h2 class="text-2xl font-bold mb-6 flex items-baseline gap-4">
							{year}
							<span class="h-px bg-border flex-1" />
						</h2>
						<ul class="space-y-6">
							{postsByYear[Number(year)].map(
								(post: CollectionEntry<"blog">) => (
									<li class="group">
										<a
											href={`/blog/${post.id}/`}
											class="flex flex-col sm:flex-row sm:items-baseline gap-1 sm:gap-4"
										>
											<div class="flex-1">
												<h3 class="text-lg font-medium group-hover:text-primary transition-colors">
													{post.data.title}
												</h3>
												{post.data.draft && (
													<span class="inline-flex items-center rounded-full border border-yellow-200 bg-yellow-50 px-2 py-0.5 text-xs font-medium text-yellow-800 mt-1">
														Draft
													</span>
												)}
											</div>
											<time
												datetime={post.data.pubDate.toISOString()}
												class="text-sm text-muted-foreground font-mono whitespace-nowrap"
											>
												{post.data.pubDate.toLocaleDateString(
													"en-us",
													{
														month: "short",
														day: "numeric",
													},
												)}
											</time>
										</a>
									</li>
								),
							)}
						</ul>
					</section>
				))
			}
		</div>
	</div>
</BlogLayout>
