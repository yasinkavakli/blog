---
import "../styles/global.css";
import BaseHead from "../components/BaseHead.astro";
import LayoutWrapper from "../components/layout-wrapper.tsx";
import { getImage } from "astro:assets";
import avatarSrc from "../../public/assets/avatar.png";
import { hasBlogPosts } from "../lib/blog-utils";

interface Props {
	title: string;
	description?: string;
	ogImage?: string;
	breadcrumbs?: { label: string; href?: string }[];
}

const {
	title,
	description = "A minimal blog.",
	ogImage,
	breadcrumbs,
} = Astro.props;

const optimizedAvatar = await getImage({
	src: avatarSrc,
	width: 64,
	height: 64,
	format: "webp",
});

const blogPostsExist = await hasBlogPosts();
---

<!doctype html>
<html lang="en" class="antialiased bg-sidebar">
	<head>
		<BaseHead title={title} description={description} ogImage={ogImage} />
		<!-- Critical CSS for theme to prevent flash and FCP -->
		<style>
			:root {
				--radius: 0.625rem;
				--background: oklch(1 0 0);
				--foreground: oklch(0.141 0.005 285.823);
				--sidebar: oklch(0.985 0 0);
				--sidebar-foreground: oklch(0.141 0.005 285.823);
			}
			.dark {
				--background: oklch(0.141 0.005 285.823);
				--foreground: oklch(0.985 0 0);
				--sidebar: oklch(0.141 0.005 285.823);
				--sidebar-foreground: oklch(0.985 0 0);
			}
			html {
				color-scheme: light dark;
				font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			}
			body {
				background-color: hsl(var(--sidebar));
				color: hsl(var(--sidebar-foreground));
				margin: 0;
				padding: 0;
				min-height: 100vh;
			}
			main {
				background-color: hsl(var(--background));
				color: hsl(var(--foreground));
			}
		</style>
		<script is:inline>
			function updateTheme() {
				const theme = localStorage.getItem("theme") || "system";
				const systemDark = window.matchMedia(
					"(prefers-color-scheme: dark)",
				).matches;
				const isDark =
					theme === "dark" || (theme === "system" && systemDark);

				document.documentElement.classList.toggle("dark", isDark);
				document.documentElement.setAttribute("data-theme", theme);
			}

			// Initialize
			updateTheme();

			// Listen for system theme changes
			window
				.matchMedia("(prefers-color-scheme: dark)")
				.addEventListener("change", updateTheme);
		</script>
	</head>
	<body class="min-h-svh">
		<LayoutWrapper
			client:idle
			breadcrumbs={breadcrumbs}
			avatarSrc={optimizedAvatar.src}
			hasBlogPosts={blogPostsExist}
		>
			<slot />
		</LayoutWrapper>
	</body>
</html>
